version: '3.4'

services:
        
  mariadb:
    image: 'mariadb:10.0.33'
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - MYSQL_PORT_NUMBER=${MYSQL_PORT_NUMBER}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - TZ=${MYSQL_TIMEZONE}
    ports:
    - ${MYSQL_PORT_NUMBER}
    volumes:
      - './mariadb_data:/var/lib/mysql'
    restart: always

  python-django:
    build:       
     context: ./django_data
     args:
      APP_NAME: ${DJANGO_APP_NAME}
    command: bash -c '
     django-admin startproject ${DJANGO_APP_NAME} || echo "Pass django-admin startproject ${DJANGO_APP_NAME} " && echo "-----ok-----1" &&
     gunicorn ${DJANGO_APP_NAME}.wsgi:application --chdir /code/${DJANGO_APP_NAME} -w 2 -b :${DJANGO_PORT} ${GUNICORN_CMD_ARGS}'
    environment:
      - VIRTUAL_HOST=${VIRTUAL_HOST}
      - LETSENCRYPT_HOST=${LETSENCRYPT_HOST}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
    ports:
      - ${DJANGO_OUTSIDE_PORT}:${DJANGO_PORT}
      - ${DJANGO_DEBUG_PORT}:${DJANGO_DEBUG_PORT}
    depends_on:
      - mariadb
    volumes:
      - ./django_data/src:/code
      - ./django_data/static:/static
    restart: always

volumes:
  mariadb_data:
    driver: local

networks:
  default:
    external:
      name: webproxy
